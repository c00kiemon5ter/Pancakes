#!/usr/bin/env bash

cmd="$1"
who="${3%\!*}"
whoami="$4"

readonly chan="$2"
readonly oper="$USER"

sayit() {
    if [[ -n "${newho:-${who}}" ]]
    then printf -- "PRIVMSG %s :%s: %s\n" "${chan}" "${newho:-${who}}" "${*}"
    else printf -- "PRIVMSG %s :%s\n" "${chan}" "${*}"
    fi
}

if [[ "${cmd}" =~ ^[[:alnum:]]+[[:space:]]*\>[[:space:]]*[[:alnum:]_-]+ ]]; then
    IFS=\>${IFS} read -r cmd mesg   <<< "${cmd}"
                 read -r newho mesg <<< "${mesg}"
elif [[ "${cmd}" =~ [[:alnum:]]+[[:space:]]*\>[[:space:]]*[[:alnum:]_-]+$ ]]; then
    IFS=\> read -r mesg newho <<< "${cmd}"
           read -r cmd mesg   <<< "${mesg}"
           read -r newho      <<< "${newho}"
else
    read -r cmd mesg <<< "${cmd}"
fi

commands=(
    bloat bugs calc cookies isup echo faith
    fortune google help/list links money
    ping/test random pbin news rtfm meme
    sexy slap url yuno r/rhyme
)

[[ "${cmd,,}" == "random" ]] && cmd="${commands[RANDOM%${#commands[@]}]}"

case "${cmd}" in
    JOIN)
        messages=(
            "la presentato le herpino, ${who}"
            "yo ${who}"
            "kalws ton ${who}"
            "pws ki apo dw ${who}"
            "pou sai re ${who}"
            "pou eisai mwri ${who} ?"
            "lol, ${who} - yolo yolo yolo!"
        )
        if [[ "${who}" == "${oper}" ]]
        then who= newho= sayit "EGERTHEITW!"
        else who= newho= sayit "${messages[RANDOM%${#messages[@]}]}"
        fi
        ;;
    PART)
        messages=(
            "bye herp derp, ${who}"
            "yolo ${who}"
            "tsagia ${who}"
            "antios ${who}"
            "ta leme re ${who}"
            "antio mwri ${who} ?"
            "gn ${who} - pr0n addict!"
        )
        if [[ "${who}" == "${oper}" ]]
        then who= newho= sayit "TA SEVOI MOY!"
        else who= newho= sayit "${messages[RANDOM%${#messages[@]}]}"
        fi
        ;;
    bloat)
        unset who
        if [[ -n "${mesg}" ]]
        then sayit "${mesg} is bloat!"
        else sayit "bloat is bloat!"
        fi
        ;;
    bugs)
        unset who && sayit "0+2=4 // New Math era! https://bugs.php.net/bug.php?id=61095"
        ;;
    calc)
        mesg="$(bc -l <<< "${mesg}")"
        if [[ -z "${mesg}" ]]
        then sayit "err, ..no"
        else sayit "${mesg}"
        fi
        ;;
    cookies)
        if [[ "${who}" == "${oper}" ]]
        then sayit "om nom nom nom nom nom nom nom nom nom"
        else sayit "bake em' for master ${oper}"
        fi
        ;;
    meme)
        unset who
        messages=(
            "multi ? MUTLI BIKINI ! ΧΩΡΟ-ΧΡΟΝΙΚΗ ΔΙΑΣΠΑΣΗ ΤΩΡΑ ! http://www.arpisoft.gr/patents.html + http://arpisoft/mb.pdf"
            "Sigh. Why my pie die? I so hungry. Now I cry. Life is just a lie. X-(  http://bit.ly/9jwK84"
            "wat? wtf? you haven't read this I guess: http://timecube.com/"
            "ITSATRAP! http://chickencrap.com/media_images/4922.gif"
            "forever aloooone! http://i.imgur.com/xr7Kl.jpg"
            "ULTRAgaaaay http://i.imgur.com/XJ4Aq.png"
            "http://i.imgur.com/SP9gwh.jpg"
            "http://i.imgur.com/EPaUf.jpg"
            "http://i.imgur.com/zV3Wz.gif :3"
            'http://i.imgur.com/pKttU.jpg'
            "trololololololololololololo"
            "u mad, bro? ${mesg}"
            "problem, ${mesg}?"
            "cool.story.bro."
            "failed"
        )
        sayit "${messages[RANDOM%${#messages[@]}]}"
        ;;
    isitup)
        awk '{ for (i=1; i<=NF; i++)
        if ($i ~ /^http/) print substr($i, index($i, "://") + 3)
        else if ($i ~ /^www/) print $i
        }' <<< "$mesg" | \
            while read -r site; do
                sayit "$(curl -s "http://isitup.org/${site}" | \
                    awk -F"[<>]" '{ for (i=1; i<=NF; i++) if(tolower($i) == "title") { print $(i+1); exit } }')"
            done
        ;;
    echo)
        unset who && sayit "$mesg"
        ;;
    faith)
        unset who
        sayit "believe in Him, trust in Him, be His friend, He will save you. https://lists.launchpad.net/unity-design/msg08084.html"
        ;;
    fortune)
        unset who newho
        while read -r
        do sayit "$REPLY"
        done < <(fortune -osea)
        ;;
    [Ff][Uu])
        sayit "fffuuuuuuuuuuuuuuuuuuuuu !!!!!!! >:("
        ;;
    gn)
        if [[ -z "${newho}" ]]
        then who= sayit "sleep is for the weak."
        else sayit "sleep tight you weak! ${mesg}"
        fi
        ;;
    google)
        unset who
        readonly api='http://ajax.googleapis.com/ajax/services/search/web?v=1.0'
        curl -s --get --data-urlencode "q=${mesg// /+}" "${api}"                                | \
            awk -F"[\"\"]" '{ for (i=2; i<=NF; i+=2) if ($i == "unescapedUrl") print $(i+=2) }' | \
            while read -r
            do sayit "· $REPLY"
            done
        ;;
    news)
        unset who
        readonly napi='http://www.google.com/ig/api?news'
        readonly tapi='http://api.bitly.com/v3/shorten?login=pancakesbot&apiKey=R_ac2adceb07f01d8faca52bb77c67293b&longUrl='
        curl -s "${napi}" | awk -F"[<=>\"\"]" '{
        for (f=40; f<=NF; f++)
            if ($f == "title data") a[i++]=$(f+=2)
            else if ($f == "url data") a[i++]=$(f+=2)
        } END { for (i=0; i<=length(a)/2; i+=2) printf("%s - %s\n",a[i+1],a[i]) }' | \
            while read -r url title; do
                tiny="$(curl -s "${tapi}${url}&format=txt")"
                sayit "${tiny:-"$url"} ${title:-"no title found"}"
            done
        ;;
    help|list)
        sayit "help yourself! http://sweet.nodns4.us/"
        sayit "${commands[*]}"
        ;;
    links)
        sayit "all you links are belong to me! https://bitly.com/u/pancakesbot"
        ;;
    money)
        unset who newho
        if [[ "$mesg" =~ ^[[:digit:]]+[[:space:]]+[[:alpha:]]+[[:space:]]+[[:alpha:]]+ ]]; then
            read n f t _ <<< "${mesg}"
            mesg="$(curl -s 'http://www.google.com/ig/calculator?hl=en&q='${n}${f}=?${t} \
                | awk -F"[\"\"]" '$2 { printf("%s is %s\n",$2,$4) }')"
            if [[ -z "${mesg}" ]]
            then sayit "no such unit"
            else sayit "${mesg}"
            fi
        else
            newho= sayit "invalid input"
        fi
        ;;
    pbin)
        unset who && sayit "http://sprunge.us/  http://ideone.com  http://codepad.org/  http://dpaste.com"
        ;;
    dict)
        unset who
        readonly api='http://glosbe.com/gapi/translate?'
        read -r word _ <<< "$mesg"
        curl -s "${api}from=${from:-"eng"}&dest=${to:-"eng"}&format=json&phrase=${word}&pretty=true" | \
            awk -F"[\"\"]" -vw="$word" '$2 == "text" { if ($4 != w) print $4; if (++i == 10) { exit } }' | \
            while read -r
            do sayit "· $REPLY"
            done
        ;;
    r|rhyme)
        while read -r word; do
            word="$(tr -cd "*αβγδεζηθικλμνξοπρστυφχψωΑΒΓΔΕΖΗΘΙΚΛΜΝΞΟΠΡΣΤΥΦΧΨΩ[:alnum:]" <<< "$word")"
            r=( $(grep -h "^${word//[*]/[^/]*}$" /usr/share/hunspell/en_US.dic <(iconv -f ISO8859-7 -t UTF8 /usr/share/hunspell/el_GR.dic)) )
            (( !$? )) && mesg="$(sed "s/${word//[*]/[*]}/${r[RANDOM%${#r[@]}]}/" <<< "$mesg")"
        done < <(awk '{ for (i=1; i<=NF; i++) if ($i ~ /[*]/) print $i }' <<< "${mesg}")
        sayit "${mesg:-"what's the line punk?"}"
        ;;
    rtfm)
        unset who && sayit "be a man, read the man http://xkcd.com/293/"
        ;;
    sexy)
        sayit "le sexy time <3 ${mesg}"
        ;;
    slap)
        sayit "${who} slaps ${newho:-"his cohones"} with a large ${mesg:-"smelly potato donut"}"
        ;;
    ping|test)
        if [[ -z "${newho}" ]]
        then sayit "tost ready!"
        else sayit "ping!"
        fi
        ;;
    url)
        unset who newho
        readonly api='http://api.bitly.com/v3/shorten?login=pancakesbot&apiKey=R_ac2adceb07f01d8faca52bb77c67293b&longUrl='
        awk '{ for (i=1; i<=NF; i++) if ($i ~ /^http/) print $i }' <<< "$mesg" | \
            while read -r url; do
                # minify link if needed
                (( ${#url} >= 70 )) && tiny="$(curl -s "${api}${url}&format=txt")"
                # get link title
                if [[ "${url}" =~ ^http://(www\.)youtu\.?be ]]
                then url="${url##*v=}" url="http://www.youtube.com/embed/${url%%&*}"
                fi
                title="$(curl -s "${url}" | awk -F"[<>]" '{ for (i=1; i<=NF; i++) if(tolower($i) ~ /title( .+)?/) { print $(i+1); exit } }')"
                # we're done
                [[ -n "${title}" || -n "${tiny}" ]] && sayit "${tiny} -- ${title:-"no title found"}"
            done
        ;;
    [yY][uU][nN][oO])
        sayit "Y U NO ${mesg:-"y u no?"}"
        ;;
    *)
        messages=(
            "you don't know what you're talking about, do you?"
            "NO, YOU ${cmd} ${mesg}"
            "apo ta lathi mathainoume, tekna mou"
            "are you a midget, ${who} ?"
            "no faggots here, ${who}"
            "are you tryning to fool me ? are you trying to fool ${whoami} ?"
        )
        unset newho
        if [[ "${who}" == "${oper}" ]]
        then who= sayit "ESFALA ARXONTA!"
        else sayit "${messages[RANDOM%${#messages[@]}]}"
        fi
        ;;
esac

